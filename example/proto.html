<!DOCTYPE html>
<meta charset=utf-8>
<title></title>

<div id="entry"></div>

<script src="../index.js"></script>
<script>
var html =
  '<div class="post">' +
    '<h1>By Alan Johnson</h1>' +
    '<div class="body">I Love Handlebars</div>' +
    '\n' +
    '<h1>Comments</h1>' +
    '\n' +
    '<h2>By Yehuda Katz</h2>' +
    '<div class="body">Me Too!</div>' +
  '</div>'

function Expression(source) {
  this.source = source;
}
Expression.prototype.toString = function() {
  return this.source;
};
Expression.prototype.get = function(context) {
  return context.getProperty(this.source);
};

function IfExpression(source) {
  this.source = source;
  this.expression = new Expression(source);
}
IfExpression.prototype = new Expression;
IfExpression.prototype.toString = function() {
  return 'if ' + this.source;
};
IfExpression.prototype.get = function(context) {
  var value = this.expression.get(context);
  return (Array.isArray(value) && value.length === 0) ? null : value;
};

function UnlessExpression(source) {
  this.source = source;
  this.expression = new IfExpression(source);
}
UnlessExpression.prototype = new Expression;
UnlessExpression.prototype.toString = function() {
  return 'unless ' + this.source;
};
UnlessExpression.prototype.get = function(context) {
  return !this.expression.get(context);
};

function EachExpression(source) {
  this.source = source;
  this.expression = new Expression(source);
}
EachExpression.prototype = new Expression;
EachExpression.prototype.toString = function() {
  return 'each ' + this.source;
};
EachExpression.prototype.get = function(context) {
  return this.expression.get(context);
};

var template = new Template([
  new Element('div', {
    'class': new Attribute('post')
  }, [
    new Element('h1', null, [
      new Text('By ')
    , new TextExpression(new Expression('author'))
    ])
  , new Element('div', {
      'class': new Attribute('body')
    }, [
      new TextExpression(new Expression('body'))
    ])
  , new Text('\n')
  , new Comment('Go, go comment node!')
  , new ConditionalBlock([new IfExpression('comments'), null], [[
        new Element('h1', null, [
          new Text('Comments')
        ])
      , new Text('\n')
      ], [
        new Element('h1', null, [
          new Text('No comments')
        ])
      ]
    ])
  , new EachBlock(new EachExpression('comments'), [
      new Element('h2', null, [
        new Text('By ')
      , new Block('nonsense', [
          new TextExpression(new Expression('author'))
        ])
      ])
    , new Element('div', {
        'class': new Attribute('body')
      }, [
        new TextExpression(new Expression('body'))
      ])
    ], [
      new Text('Lamers')
    ])
  ])
]);

function ContextEvents(add, remove, update) {
  this.add = add;
  this.remove = remove;
  this.update = update;
}
function Context(events, data, parent) {
  this.events = events;
  this.data = data;
  this.parent = parent;
}
Context.prototype.get = function(expression) {
  return (expression == null) ? this.data :
    (expression instanceof Expression) ? expression.get(this) :
    this.getProperty(expression);
};
Context.prototype.getProperty = function(property) {
  var value = this.data && this.data[property];
  return value || this.parent && this.parent.getProperty(property);
};
Context.prototype.child = function(expression) {
  var data = this.get(expression);
  return new Context(this.events, data, this);
};

var bindings = {};
var count = 0;
function addBinding(binding) {
  var id = binding.id = ++count;
  bindings[id] = binding;
  console.log('add', binding, id);
}
function removeBinding(binding) {
  delete bindings[binding.id];
  console.log('remove', binding);
}
function updateBinding(binding) {
  console.log('update', binding);
}
var events = new ContextEvents(addBinding, removeBinding, updateBinding);

var context = new Context(events, {
  author: 'Alan Johnson'
, body: 'I Love Handlebars'
, comments: [{
    author: 'Parker Blue'
  , body: 'Me too!'
  }, {
    author: 'Sarah Shannon'
  , body: 'Me too!'
  }]
});

var el = document.getElementById('entry');
el.innerHTML = template.getHtml(context);

var fragment = template.getFragment(context);
replaceBindings(fragment, el);

// var j = 5;
// run();

function run() {
  var i = 10000;
  var start = +new Date;
  var sum = 0;
  while (--i) {
    binding.update(context);
    // while (el.firstChild) el.removeChild(el.firstChild)
    // el.appendChild(template.getFragment(context));
    // el.innerHTML = template.getHtml(context);
  }
  console.log(new Date - start);
  if (--j) setTimeout(run, 50);
}

</script>
