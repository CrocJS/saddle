<!DOCTYPE html>
<meta charset=utf-8>
<title></title>

<div id="entry"></div>

<script src="../index.js"></script>
<script>
var html =
  '<div class="post">' +
    '<h1>By Alan Johnson</h1>' +
    '<div class="body">I Love Handlebars</div>' +
    '\n' +
    '<h1>Comments</h1>' +
    '\n' +
    '<h2>By Yehuda Katz</h2>' +
    '<div class="body">Me Too!</div>' +
  '</div>'

var template = new Template([
  new Element('div', {
    'class': new Attribute('post')
  }, [
    new Element('h1', null, [
      new Text('By ')
    , new TextExpression('author')
    ])
  , new Element('div', {
      'class': new Attribute('body')
    }, [
      new TextExpression('body')
    ])
  , new Text('\n')
  , new Comment('Go, go comment node!')
  , new ConditionalBlock(['if comments', null], [[
        new Element('h1', null, [
          new Text('Comments')
        ])
      , new Text('\n')
      ], [
        new Text('No comments')
      ]
    ])
  , new EachBlock('each comments', [
      new Element('h2', null, [
        new Text('By ')
      , new Block('author', [
          new TextExpression('this')
        ])
      ])
    , new Element('div', {
        'class': new Attribute('body')
      }, [
        new TextExpression('body')
      ])
    ], [
      new Text('Lamers')
    ])
  ])
]);

function ContextEvents(add, remove, update) {
  this.add = add;
  this.remove = remove;
  this.update = update;
}
function Context(events, data, parent) {
  this.events = events;
  this.data = data;
  this.parent = parent;
}
Context.prototype.get = function(name) {
  // Strip out keywords
  // TODO: use objects with filter method instead
  var filter;
  if (typeof name === 'string') {
    if (/^if /.test(name)) {
      name = name.slice(3);
      filter = 'if';
    } else if (/^unless /.test(name)) {
      name = name.slice(7);
      filter = 'unless';
    } else if (/^else if /.test(name)) {
      name = name.slice(8);
      filter = 'if';
    } else if (/^each /.test(name)) {
      name = name.slice(5);
      filter = 'each';
    }
  }

  if (name == null || name === 'this') return this.data;
  var value = this.data && this.data[name];
  if (filter) {
    if (filter === 'if') {
      if (Array.isArray(value) && value.length === 0) value = null;
    } else if (filter === 'unless') {
      value = !value;
    }
  }
  return value || this.parent && this.parent.get(name);
};
Context.prototype.child = function(name) {
  var data = this.get(name);
  return new Context(this.events, data, this);
};

var bindings = {};
var count = 0;
function addBinding(binding) {
  var id = binding.id = ++count;
  bindings[id] = binding;
  console.log('add', binding, id);
}
function removeBinding(binding) {
  delete bindings[binding.id];
  console.log('remove', binding);
}
function updateBinding(binding) {
  console.log('update', binding);
}
var events = new ContextEvents(addBinding, removeBinding, updateBinding);

var context = new Context(events, {
  author: 'Alan Johnson'
, body: 'I Love Handlebars'
, comments: [{
    author: 'Parker Blue'
  , body: 'Me too!'
  }, {
    author: 'Sarah Shannon'
  , body: 'Me too!'
  }]
});

var el = document.getElementById('entry');
el.innerHTML = template.getHtml(context);

var fragment = template.getFragment(context);
replaceBindings(fragment, el);

// var j = 5;
// run();

function run() {
  var i = 10000;
  var start = +new Date;
  var sum = 0;
  while (--i) {
    binding.update(context);
    // while (el.firstChild) el.removeChild(el.firstChild)
    // el.appendChild(template.getFragment(context));
    // el.innerHTML = template.getHtml(context);
  }
  console.log(new Date - start);
  if (--j) setTimeout(run, 50);
}

</script>
